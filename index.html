<head>
  <link rel="manifest" href="manifest.webmanifest">
</head>
<body>
  <canvas id="render-canvas"></canvas>
  <div id="user-interface">
    <img id="restart-btn" src="assets/restart.png" />
  </div>
  <style>
    body, #render-canvas, #user-interface {
      margin: 0;
      width: 100%;
      height: 100vh;
    }
    #restart-btn {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 200px;
    }
  </style>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/cannon.js"></script>
  <script>
    // СОЗДАНИЕ МИРА
    let canvas = window.document.querySelector('#render-canvas');
    // Создание движка
    let engine = new BABYLON.Engine(canvas);
    // Создание сцены и присоеденение ее к движку
    let scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color3(0.3, 0.3, 0.3);
    scene.enablePhysics();
    // Создание камеры
    let camera = new BABYLON.FreeCamera('camera', new BABYLON.Vector3(0, 10, -12), scene);
    camera.setTarget(new BABYLON.Vector3(0, 0, 0));
    // Создание света
    let light = new BABYLON.PointLight('light', new BABYLON.Vector3(10, 10, 0), scene);
    light.intensity = 0.2;
    // Создание генератора теней
    let shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
    // Создание платформы и материала для нее
    const createPlatform = (zPos) => {
      let platform = new BABYLON.MeshBuilder.CreateBox('box', {
        width: 6,
        height: 0.1,
        depth: 6,
        wrap: true
      }, scene);
      let boxMaterial = new BABYLON.StandardMaterial('material', scene);
      boxMaterial.emissiveTexture = new BABYLON.Texture('assets/platform.png');
      platform.material = boxMaterial;
      platform.receiveShadows = true;
      platform.physicsImpostor = new BABYLON.PhysicsImpostor(
        platform,
        BABYLON.PhysicsImpostor.BoxImpostor,
        {
          mass: 0
        },
        scene
      );
      platform.position.z = zPos;
    }
    for(let i = 0; i < 10; i++){
      createPlatform(i*6);
    }
    // Создание препятствий
    let lastRand = 0;
    let boxArray = [];
    const createBox = (xPos, zPos) => {
      let box = new BABYLON.MeshBuilder.CreateBox('box', {
        width: 2,
        height: 1,
        depth: 1
      }, scene);
      box.position = new BABYLON.Vector3(xPos, 0.6, 3+zPos);
      box.material = new BABYLON.StandardMaterial('material', scene);
      box.material.emissiveColor = new BABYLON.Color3(0.5, 0.5, 0.5);
      box.physicsImpostor = new BABYLON.PhysicsImpostor(
        box,
        BABYLON.PhysicsImpostor.BoxImpostor,
        {
          mass: 0
        },
        scene
      );
      shadowGenerator.getShadowMap().renderList.push(box);
      box.receiveShadows = true;
      boxArray.push(box);
    }
    const createBoxRow = (zPos) => {
      let rand = Math.floor(Math.random() * 3);
      while(rand === lastRand){
        rand = Math.floor(Math.random() * 3);
      }
      lastRand = rand;
      for(let i = 0; i < 3; i++){
        if(i === rand) continue;
        createBox((i*2)-2, zPos);
      }
    }
    for(let i = 0; i < 10; i++){
      createBoxRow(i*6);
    }
    // Создание мяча и материала для него 
    let ball = new BABYLON.MeshBuilder.CreateSphere('sphere', {
      diametr: 1
    }, scene);
    ball.position.y = 3.6;
    let ballMaterial = new BABYLON.StandardMaterial('material', scene);
    ballMaterial.emissiveTexture = new BABYLON.Texture('assets/ball.png');
    ball.material = ballMaterial;
    shadowGenerator.getShadowMap().renderList.push(ball);
    ball.physicsImpostor = new BABYLON.PhysicsImpostor(
      ball,
      BABYLON.PhysicsImpostor.SphereImpostor,
      {
        mass: 1,
        // restitution: 4,
        friction: 5
      },
      scene
    );

    // АЛГОРИТМ
    let restartBtn = window.document.querySelector('#restart-btn');
    scene.registerBeforeRender(()=>{
      for(let i = 0; i < boxArray.length; i++){
        if(ball.intersectsMesh(boxArray[i], true)){
          boxArray[i].material.emissiveColor = new BABYLON.Color3(0.5, 0, 0);
        }
      }
    });
    engine.runRenderLoop(()=>{
      camera.position.z = ball.getAbsolutePosition().z - 12;
      light.position.z = ball.getAbsolutePosition().z;
      scene.render();
    });

    // ОБРАБОТЧИКИ СОБЫТИЙ
    restartBtn.addEventListener('click', () => window.location.reload());
    window.addEventListener('touchstart', (event) => {
      let x = event.touches[0].screenX;
      if(x > (window.screen.width/2)){
        ball.physicsImpostor.applyImpulse(
          new BABYLON.Vector3(10, 0, 0),
          ball.getAbsolutePosition()
        );
      }else{
        ball.physicsImpostor.applyImpulse(
          new BABYLON.Vector3(-10, 0, 0),
          ball.getAbsolutePosition()
        );        
      }
    });
    window.addEventListener('touchend', () => {
      ball.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(0, 0, 5));
      ball.physicsImpostor.setAngularVelocity(new BABYLON.Vector3(0, 0, 0,));
    });
    window.addEventListener('beforeinstallprompt', (event) =>{
      event.preventDefault();
    });
  </script>
</body>